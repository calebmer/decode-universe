#!/bin/bash

export NODE_ENV=production

rm -rf build

$(cd ../.. && npm bin)/tsc --project ./tsconfig.main.json

$(npm bin)/webpack --config ./webpack.config.renderer.js

# We don’t currently specify any dependencies because the main process does not
# need any dependencies other then Electron.
echo '{
  "private": true,
  "productName": "Decode Studio",
  "name": "@decode/studio-desktop",
  "version": "0.0.0-versionless",
  "main": "./main/index.js",
  "dependencies": {
    "debug": "^2.6.3",
    "immutable": "^3.8.1",
    "moment": "^2.18.1",
    "react": "^15.4.2",
    "react-dom": "^15.4.2",
    "rxjs": "^5.3.0",
    "socket.io-client": "^1.7.3",
    "tslib": "^1.6.0",
    "uuid": "^3.0.1"
  }
}' > build/package.json

# Clearly this is tied to Caleb’s computer setup as the path to Electron is
# hardcoded. This is temporary.
electron_app_path=/Users/calebmer/Software/electron/Electron.app

cp -R $electron_app_path build/Decode\ Studio.app

mkdir -p build/Decode\ Studio.app/Contents/Resources/app

cp build/package.json build/Decode\ Studio.app/Contents/Resources/app/package.json
cp -r build/main build/Decode\ Studio.app/Contents/Resources/app/main
cp -r build/renderer build/Decode\ Studio.app/Contents/Resources/app/renderer

cd build/Decode\ Studio.app/Contents/Resources/app
npm install
